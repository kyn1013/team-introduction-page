<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>방명록 페이지</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        .nav-item .nav-link {
            color: black;
            border-radius: 20px;
        }

        /* 이미지 */
        .mainimg {
            height: 50vh;
            width: 50vw;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background-image: url(https://i.pinimg.com/originals/fd/31/de/fd31de8e18a40f0dee3dd3c5f402d7dd.jpg);
            background-position: center;
            background-size: cover;
            border: 0px solid #ccc;
            border-radius: 30px;
            overflow: hidden;
        }



        /* 중단 작성칸 */
        .writingBox {
            width: 700px;
            margin: 20px auto;
            position: cneter;
            padding: 10px;
        }

        .form-control {
            border-radius: 20px;
        }

        /* .writingBoxButton {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: -10px;

        } */

        /* .remove-button {
            background-color: #ffffff;
            color: #007adf;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            border: 1px solid #007adf;
            border-radius: 4px;
            text-align: center;
            border-radius: 20px;
        }

        .remove-button:hover {
            background-color: #007adf;
            color: #fff;
        } */

        .btn {
            flex: 1 1 auto;
            margin: 20px auto 20px auto;
            text-align: center;
            text-transform: uppercase;
            transition: 0.5s;
            background-size: 200% auto;
            color: rgb(255, 255, 255);
            text-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
            box-shadow: 0 0 20px #eee;
            border-radius: 10px;
        }

        .btn:hover {
            background-position: right center;
        }

        .btn-4 {
            background-image: linear-gradient(to right, #CEF6F5 0%, #c2e9fb 51%, #a1c4fd 100%);
        }

        .btn-4 {
            font-size: 20px;
            width: 200px;
        }

        /* .write-button {
            background-color: #007adf;

            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            border-radius: 20px;
        }

        .write-button:hover {
            background-color: #11269e;
        } */

        /* 중하단 구분선 */
        .line {
            border: none;
            border-top: 1px solid #007adf;
            margin: 20px auto;
            width: 70%;

        }

        /* 정렬 버튼 */
        .sortBtn {
            display: flex;
            justify-content: right;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            margin-right: 26.5%;
            margin-bottom: -10px;
        }

        .sortLatestBtn,
        .sortOldestBtn {
            padding: 5px 15px;
            border: 1px solid #007adf;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            color: #007adf;
            border-radius: 20px;
        }

        .sortLatestBtn:hover,
        .sortOldestBtn:hover {
            background-color: #007adf;
            color: #ffffff;
            border-color: #ffffff;
        }

        .btn-active {
            background-color: #007adf;
            color: white;

        }



        /* 하단 방명록 목록 */
        .commentList {
            position: cneter;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 190px;
            padding: 10px;


        }

        .commentItem {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
            border-radius: 30px;
        }

        .nickname {
            font-weight: bold;
            color: #333;
            flex-shrink: 0;
            border-right: 1px solid #ccc;
            margin: 5px 5px;
            padding-right: 10px;
            text-align: center;
            width: 100px;
            flex-shrink: 0;
        }

        .content {
            flex: 1;
            color: #555;
            word-break: break-word;
            text-align: left;
            width: 1000px;
            flex-shrink: 0;
        }

        .password {
            width: 90px;
            padding: 5px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            border-radius: 30px;
        }

        .deleteBtn {
            padding: 5px 10px;
            font-size: 14px;
            color: #007adf;
            background-color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
            border: 1px solid #007adf;
            border-radius: 30px;
        }

        .deleteBtn:hover {
            background-color: #007adf;
            color: #fff;
        }

        .saveBtn,
        .modifyeBtn {
            padding: 5px 10px;
            font-size: 14px;
            color: #fff;
            background-color: #007adf;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
            border-radius: 30px;
        }

        .modifyeBtn:hover {
            background-color: #11269e;
        }

        .date {
            margin-left: auto;
            font-size: 14px;
            color: #888;
            flex-shrink: 0;
            border-left: 1px solid #ddd;
            padding-left: 10px;
        }
    </style>
    <script type="module">
        // DB import 
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyDwdevGNOHBHjZGo6STdq_0ZU5JhG9ccP0",
            authDomain: "introduction-c71ef.firebaseapp.com",
            projectId: "introduction-c71ef",
            storageBucket: "introduction-c71ef.firebasestorage.app",
            messagingSenderId: "305175752966",
            appId: "1:305175752966:web:5e3f9298fe6b143d1e2e87"
        };


        // Firebase 인스턴스 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);


        // 지우기 버튼 누를 시
        $("#removeBtn").click(async function () {
            writingNickname.value = '';
            writingPassword.value = '';
            writingComment.value = '';
        })

        // 날짜 관련
        const nowDate = new Date();
        const year = nowDate.getFullYear();
        const month = String(nowDate.getMonth() + 1).padStart(2, '0');
        const day = String(nowDate.getDate()).padStart(2, '0');
        const hours = String(nowDate.getHours()).padStart(2, '0');
        const minutes = String(nowDate.getMinutes()).padStart(2, '0');

        // 작성 버튼 누를 시
        $("#writingBtn").click(async function () {
            let nickname = $('#writingNickname').val();
            let password = $('#writingPassword').val();
            let comment = $('#writingComment').val();
            const date = `${year}-${month}-${day} ${hours}:${minutes}`;

            let doc = {
                'nickname': nickname,
                'password': password,
                'comment': comment,
                'date': date
            };
            await addDoc(collection(db, "guestbook"), doc);
            alert('방명록이 작성되었습니다');
            window.location.reload();
        })

        let docs = await getDocs(collection(db, "guestbook"));

        docs.forEach((doc) => {
            let row = doc.data();
            let docId = doc.id;

            let nickname = row['nickname'];
            let password = row['password'];
            let comment = row['comment'];
            let date = row['date'];

            let temp_html = `            
            <div class="commentItem">
                <span class="nickname">${nickname}</span>
                <span class="content">${comment}</span>
                <span class="date">${date}</span>
                <input type="password" class="password" placeholder="비밀번호">
                <button class="modifyeBtn" data-id="${docId}" data-password="${password}">수정</button>
                <button class="deleteBtn" data-id="${docId}" data-password="${password}">X</button>
            </div>`;
            $('#guestbookList').append(temp_html);
        });


        // 수정 버튼 누를 시

        $(document).on('click', '.modifyeBtn', function () {
            let parentDiv = $(this).closest('.commentItem');
            let passwordInput = parentDiv.find('.password').val().trim();
            let storedPassword = $(this).data('password');
            let docId = $(this).data('id');

            if (passwordInput === String(storedPassword)) {
                let content = parentDiv.find('.content').text();
                parentDiv.find('.content').replaceWith(`<input type="text" class="editContent form-control" value="${content}">`);
                $(this).text('저장');
                $(this).removeClass('modifyeBtn').addClass('saveBtn');
            } else {
                alert("비밀번호가 틀렸습니다");
            }
        });

        // 수정-저장 버튼 누를 시
        $(document).on('click', '.saveBtn', async function () {
            let parentDiv = $(this).closest('.commentItem');
            let newContent = parentDiv.find('.editContent').val().trim();
            let docId = $(this).data('id');
            const currentDate = `${year}-${month}-${day} ${hours}:${minutes}`;

            if (newContent) {
                try {
                    await updateDoc(doc(db, "guestbook", docId), {
                        comment: newContent,
                        date: currentDate
                    });
                    alert("방명록이 수정되었습니다");
                    window.location.reload();
                } catch (error) {
                    console.error("수정 실패: ", error);
                    alert("수정 중 오류가 발생했습니다");
                }
            } else {
                alert("내용을 입력해주세요");
            }
        });


        // 삭제 버튼 누를 시
        $(document).on('click', '.deleteBtn', async function () {
            let passwordInput = $(this).siblings('.password').val();
            let storedPassword = $(this).data('password');
            let docId = $(this).data('id');

            if (passwordInput === String(storedPassword)) {
                try {
                    await deleteDoc(doc(db, "guestbook", docId));
                    alert("방명록이 삭제되었습니다");
                    window.location.reload();
                } catch (error) {
                    console.error("삭제 실패: ", error);
                    alert("삭제 중 오류가 발생했습니다");
                }
            } else {
                alert("비밀번호가 틀렸습니다");


            }
        });

        // 삭제 디버그 코드
        // console.log("입력된 비밀번호: ", passwordInput);
        // console.log("저장된 비밀번호: ", storedPassword);
        // console.log("문서 ID: ", docId);
        // console.log("입력된 비밀번호 타입:", typeof passwordInput);
        // console.log("저장된 비밀번호 타입:", typeof storedPassword);


        // 정렬 버튼
        document.getElementById("sortLatest").addEventListener("click", function () {
            this.classList.add("btn-active");
            document.getElementById("sortOldest").classList.remove("btn-active");

            sortGuestbookList('latest');
        });

        document.getElementById("sortOldest").addEventListener("click", function () {
            this.classList.add("btn-active");
            document.getElementById("sortLatest").classList.remove("btn-active");

            sortGuestbookList('oldest');
        });


        function sortGuestbookList(order) {
            let guestbookList = document.getElementById("guestbookList");
            let items = Array.from(guestbookList.getElementsByClassName("commentItem"));

            items.sort((a, b) => {
                let dateA = new Date(a.querySelector('.date').innerText);
                let dateB = new Date(b.querySelector('.date').innerText);

                if (order === 'latest') {
                    return dateB - dateA;
                } else {
                    return dateA - dateB;
                }
            });

            guestbookList.innerHTML = '';
            items.forEach(item => guestbookList.appendChild(item));
        }

        sortGuestbookList('latest');

    </script>
</head>

<body>
    <header>
        <div class="container">
            <header class="d-flex justify-content-center py-3">
                <ul class="nav nav-pills">
                    <li class="nav-item"><a href="main.html" class="nav-link" aria-current="page">Main</a></li>
                    <li class="nav-item"><a href="create_member.html" class="nav-link">create</a></li>
                    <li class="nav-item"><a href="introduction.html" class="nav-link">introduce</a></li>
                    <li class="nav-item"><a href="guestbook.html" class="nav-link active"
                            style="background-color: #CEF6F5;">guest book</a></li>
                </ul>
            </header>
        </div>
    </header>

    <!-- 방명록 페이지 입니다 -->

    <!-- 이미지 -->
    <div class="mainimg">

    </div>

    <!-- 중단 작성칸 -->
    <div class="writingBox" id="writingBox">
        <div class="form-floating mb-3">
            <input type="text" class="form-control" id="writingNickname" placeholder="닉네임">
            <label for="floatingInput">닉네임</label>
        </div>
        <div class="form-floating mb-3">
            <input type="password" class="form-control" id="writingPassword" placeholder="비밀번호">
            <label for="floatingInput">비밀번호</label>
        </div>
        <div class="form-floating mb-3">
            <input type="message" class="form-control" id="writingComment" placeholder="내용">
            <label for="floatingInput">내용을 입력해주세요</label>
        </div>
        <!-- <div class="writingBoxButton">
            <button id="removeBtn" class="remove-button">지우기</button>
             <button id="writingBtn" class="write-button">작성하기</button>

        </div> -->
        <div class="button">
            <div class="d-grid gap-3 col-3 mx-auto text-center">
                <a class="btn btn-4 rounded-pill fw-bold text-center" id="writingBtn" id="addBtn">작성하기</a>
            </div>
        </div>
    </div>

    <!-- 중하단 구분선 -->
    <hr class="line">

    <!-- 정렬 버튼 -->
    <div class="sortBtn">
        <button id="sortLatest" class="sortLatestBtn btn-active">최신순</button>
        <button id="sortOldest" class="sortOldestBtn">오래된순</button>
    </div>

    <!-- 하단 방명록 목록 -->
    <div id="guestbookList" class="commentList">

    </div>
</body>

</html>